name: Build and Push to GHCR
on:
  push:
    branches: [ main ]   # 仅 main 分支触发
    tags: [ v* ]         # 支持版本标签触发（如 v1.0.0）

jobs:
  build-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]  # 矩阵策略并行构建两种架构
    permissions:
      contents: read
      packages: write   # 授权写入 GHCR [1,4](@ref)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- 核心配置 ---
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all  # 启用全平台模拟支持[1,7](@ref)

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container  # 启用高效构建驱动[6](@ref)

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}   # 自动使用触发者账号
          password: ${{ secrets.GITHUB_TOKEN }}  # 使用GitHub令牌认证[1,4](@ref)

      - name: Build and Push Image
        uses: docker/build-push-action@v5
        with:
          platforms: ${{ matrix.platform }}  # 动态注入矩阵架构
          context: .
          push: true
          # 动态生成标签：ARM架构添加 "-arm" 后缀
          tags: |
            ghcr.io/${{ github.repository_owner }}/rpahub:${{ github.sha }}${{ matrix.platform == 'linux/arm64' && '-arm' || '' }}
            ghcr.io/${{ github.repository_owner }}/rpahub:latest${{ matrix.platform == 'linux/arm64' && '-arm' || '' }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/rpahub:buildcache  # 使用Registry缓存加速[6](@ref)
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/rpahub:buildcache,mode=max

      # --- 可选：创建多架构Manifest（合并标签）---
      - name: Create Manifest for Latest Tag
        if: matrix.platform == 'linux/amd64'  # 仅在AMD64任务中执行一次
        run: |
          docker buildx imagetools create \
            --tag ghcr.io/${{ github.repository_owner }}/rpahub:latest \
            ghcr.io/${{ github.repository_owner }}/rpahub:latest \
            ghcr.io/${{ github.repository_owner }}/rpahub:latest-arm
